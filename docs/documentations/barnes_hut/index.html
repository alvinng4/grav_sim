
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../integrators/">
      
      
        <link rel="next" href="../comoving_coordinates/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.13">
    
    
      
        <title>Barnes-Hut algorithm - grav_sim</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#linear-octree-construction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="grav_sim" class="md-header__button md-logo" aria-label="grav_sim" data-md-component="logo">
      
  <img src="../../orbit_logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            grav_sim
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Barnes-Hut algorithm
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/alvinng4/grav_sim" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    alvinng4/grav_sim
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../" class="md-tabs__link">
          
  
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting_started/" class="md-tabs__link">
          
  
  
    
  
  Getting started

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
    
  
  Documentations

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../examples/" class="md-tabs__link">
          
  
  
    
  
  Examples

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../5_steps_to_n_body_simulation/" class="md-tabs__link">
          
  
  
    
  
  5 steps to N-body simulation

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="grav_sim" class="md-nav__button md-logo" aria-label="grav_sim" data-md-component="logo">
      
  <img src="../../orbit_logo.svg" alt="logo">

    </a>
    grav_sim
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/alvinng4/grav_sim" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    alvinng4/grav_sim
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Documentations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../5_steps_to_n_body_simulation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5 steps to N-body simulation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../getting_started/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Getting started
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/installation_in_c/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation in C
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/installation_in_python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tutorial (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Documentations
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Documentations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../integrators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Integrators
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Barnes-Hut algorithm
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Barnes-Hut algorithm
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#linear-octree-construction" class="md-nav__link">
    <span class="md-ellipsis">
      Linear octree construction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tree-traversal" class="md-nav__link">
    <span class="md-ellipsis">
      Tree traversal
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#benchmark" class="md-nav__link">
    <span class="md-ellipsis">
      Benchmark
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../comoving_coordinates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Comoving coordinates
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../particle_mesh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Particle-Mesh algorithm
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../massless_acceleration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Massless acceleration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../output_formats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Output formats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../force_softening/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Force Softening
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reducing_round_off_error/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reducing round off error
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../why_c/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Why C?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_11" >
        
          
          <label class="md-nav__link" for="__nav_3_11" id="__nav_3_11_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Python API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_11">
            <span class="md-nav__icon md-icon"></span>
            Python API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PythonAPI/GravitySimulatorAPI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GravitySimulatorAPI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PythonAPI/parameters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Parameters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PythonAPI/plotting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plotting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PythonAPI/System/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PythonAPI/Simulator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Simulator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PythonAPI/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_12" >
        
          
          <label class="md-nav__link" for="__nav_3_12" id="__nav_3_12_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    C API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_12">
            <span class="md-nav__icon md-icon"></span>
            C API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CAPI/grav_sim/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Grav sim
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../examples/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/solar_system_one_mil_yrs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Evolving Solar system simulation for one million years
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/asteroid_belt_animation/asteroid_belt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Asteroid belt animation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/kirkwood_gaps/kirkwood_gaps/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Formation of Kirkwood gaps
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/galaxy_collision/galaxy_collision/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Galaxy collision
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/cosmic_structure/cosmic_structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cosmic Structure Formation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../5_steps_to_n_body_simulation/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    5 steps to N-body simulation
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            5 steps to N-body simulation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../5_steps_to_n_body_simulation/step1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Step 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../5_steps_to_n_body_simulation/step2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Step 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../5_steps_to_n_body_simulation/step3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Step 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../5_steps_to_n_body_simulation/step4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Step 4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../5_steps_to_n_body_simulation/step5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Step 5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../5_steps_to_n_body_simulation/extra/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extra
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../5_steps_to_n_body_simulation/conclusion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Conclusion
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Barnes-Hut algorithm</h1>

<p>The classic Barnes-Hut algorithm<sup id="fnref:barnes_hierarchical_1986"><a class="footnote-ref" href="#fn:barnes_hierarchical_1986">1</a></sup>
provides a way to approximate forces in <span class="arithmatex">\(\mathcal{O}(N \log N)\)</span> without losing accuracy at close range.
Because gravity decays at a quadratic rate, the accuracy of long range interactions
are less important. Therefore, it is reasonable to approximate a far cluster of 
particles as a single particle with mass <span class="arithmatex">\(m = m_{\textnormal{cluster}} \)</span>
and coordinate <span class="arithmatex">\(x = x_{\textnormal{com, cluster} } \)</span>.
One simple choice of criterion is the opening angle <span class="arithmatex">\(\theta = l / d\)</span>,
where <span class="arithmatex">\(l\)</span> is the length of the cubical cell enclosing the cluster
and <span class="arithmatex">\(d\)</span> is the distance between the target particle and the
center of mass of the cluster (see figure 1).
This is purely geometric and does not depends on the 
mass or number of particles in the cluster.</p>
<figure style="text-align: center;">
  <img src="../../../examples/media/illustration_barnes_hut.png" alt="Barnes-Hut algorithm" width="800" style="display: block; margin: auto;" />
  <figcaption>Figure 1: Illustration of Barnes-Hut algorithm.</figcaption>
</figure>

<h2 id="linear-octree-construction">Linear octree construction</h2>
<details class="note">
<summary>Source code (Click to expand)</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">  1</a></span>
<span class="normal"><a href="#__codelineno-0-2">  2</a></span>
<span class="normal"><a href="#__codelineno-0-3">  3</a></span>
<span class="normal"><a href="#__codelineno-0-4">  4</a></span>
<span class="normal"><a href="#__codelineno-0-5">  5</a></span>
<span class="normal"><a href="#__codelineno-0-6">  6</a></span>
<span class="normal"><a href="#__codelineno-0-7">  7</a></span>
<span class="normal"><a href="#__codelineno-0-8">  8</a></span>
<span class="normal"><a href="#__codelineno-0-9">  9</a></span>
<span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span>
<span class="normal"><a href="#__codelineno-0-829">829</a></span>
<span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span>
<span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span>
<span class="normal"><a href="#__codelineno-0-840">840</a></span>
<span class="normal"><a href="#__codelineno-0-841">841</a></span>
<span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span>
<span class="normal"><a href="#__codelineno-0-845">845</a></span>
<span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span>
<span class="normal"><a href="#__codelineno-0-851">851</a></span>
<span class="normal"><a href="#__codelineno-0-852">852</a></span>
<span class="normal"><a href="#__codelineno-0-853">853</a></span>
<span class="normal"><a href="#__codelineno-0-854">854</a></span>
<span class="normal"><a href="#__codelineno-0-855">855</a></span>
<span class="normal"><a href="#__codelineno-0-856">856</a></span>
<span class="normal"><a href="#__codelineno-0-857">857</a></span>
<span class="normal"><a href="#__codelineno-0-858">858</a></span>
<span class="normal"><a href="#__codelineno-0-859">859</a></span>
<span class="normal"><a href="#__codelineno-0-860">860</a></span>
<span class="normal"><a href="#__codelineno-0-861">861</a></span>
<span class="normal"><a href="#__codelineno-0-862">862</a></span>
<span class="normal"><a href="#__codelineno-0-863">863</a></span>
<span class="normal"><a href="#__codelineno-0-864">864</a></span>
<span class="normal"><a href="#__codelineno-0-865">865</a></span>
<span class="normal"><a href="#__codelineno-0-866">866</a></span>
<span class="normal"><a href="#__codelineno-0-867">867</a></span>
<span class="normal"><a href="#__codelineno-0-868">868</a></span>
<span class="normal"><a href="#__codelineno-0-869">869</a></span>
<span class="normal"><a href="#__codelineno-0-870">870</a></span>
<span class="normal"><a href="#__codelineno-0-871">871</a></span>
<span class="normal"><a href="#__codelineno-0-872">872</a></span>
<span class="normal"><a href="#__codelineno-0-873">873</a></span>
<span class="normal"><a href="#__codelineno-0-874">874</a></span>
<span class="normal"><a href="#__codelineno-0-875">875</a></span>
<span class="normal"><a href="#__codelineno-0-876">876</a></span>
<span class="normal"><a href="#__codelineno-0-877">877</a></span>
<span class="normal"><a href="#__codelineno-0-878">878</a></span>
<span class="normal"><a href="#__codelineno-0-879">879</a></span>
<span class="normal"><a href="#__codelineno-0-880">880</a></span>
<span class="normal"><a href="#__codelineno-0-881">881</a></span>
<span class="normal"><a href="#__codelineno-0-882">882</a></span>
<span class="normal"><a href="#__codelineno-0-883">883</a></span>
<span class="normal"><a href="#__codelineno-0-884">884</a></span>
<span class="normal"><a href="#__codelineno-0-885">885</a></span>
<span class="normal"><a href="#__codelineno-0-886">886</a></span>
<span class="normal"><a href="#__codelineno-0-887">887</a></span>
<span class="normal"><a href="#__codelineno-0-888">888</a></span>
<span class="normal"><a href="#__codelineno-0-889">889</a></span>
<span class="normal"><a href="#__codelineno-0-890">890</a></span>
<span class="normal"><a href="#__codelineno-0-891">891</a></span>
<span class="normal"><a href="#__codelineno-0-892">892</a></span>
<span class="normal"><a href="#__codelineno-0-893">893</a></span>
<span class="normal"><a href="#__codelineno-0-894">894</a></span>
<span class="normal"><a href="#__codelineno-0-895">895</a></span>
<span class="normal"><a href="#__codelineno-0-896">896</a></span>
<span class="normal"><a href="#__codelineno-0-897">897</a></span>
<span class="normal"><a href="#__codelineno-0-898">898</a></span>
<span class="normal"><a href="#__codelineno-0-899">899</a></span>
<span class="normal"><a href="#__codelineno-0-900">900</a></span>
<span class="normal"><a href="#__codelineno-0-901">901</a></span>
<span class="normal"><a href="#__codelineno-0-902">902</a></span>
<span class="normal"><a href="#__codelineno-0-903">903</a></span>
<span class="normal"><a href="#__codelineno-0-904">904</a></span>
<span class="normal"><a href="#__codelineno-0-905">905</a></span>
<span class="normal"><a href="#__codelineno-0-906">906</a></span>
<span class="normal"><a href="#__codelineno-0-907">907</a></span>
<span class="normal"><a href="#__codelineno-0-908">908</a></span>
<span class="normal"><a href="#__codelineno-0-909">909</a></span>
<span class="normal"><a href="#__codelineno-0-910">910</a></span>
<span class="normal"><a href="#__codelineno-0-911">911</a></span>
<span class="normal"><a href="#__codelineno-0-912">912</a></span>
<span class="normal"><a href="#__codelineno-0-913">913</a></span>
<span class="normal"><a href="#__codelineno-0-914">914</a></span>
<span class="normal"><a href="#__codelineno-0-915">915</a></span>
<span class="normal"><a href="#__codelineno-0-916">916</a></span>
<span class="normal"><a href="#__codelineno-0-917">917</a></span>
<span class="normal"><a href="#__codelineno-0-918">918</a></span>
<span class="normal"><a href="#__codelineno-0-919">919</a></span>
<span class="normal"><a href="#__codelineno-0-920">920</a></span>
<span class="normal"><a href="#__codelineno-0-921">921</a></span>
<span class="normal"><a href="#__codelineno-0-922">922</a></span>
<span class="normal"><a href="#__codelineno-0-923">923</a></span>
<span class="normal"><a href="#__codelineno-0-924">924</a></span>
<span class="normal"><a href="#__codelineno-0-925">925</a></span>
<span class="normal"><a href="#__codelineno-0-926">926</a></span>
<span class="normal"><a href="#__codelineno-0-927">927</a></span>
<span class="normal"><a href="#__codelineno-0-928">928</a></span>
<span class="normal"><a href="#__codelineno-0-929">929</a></span>
<span class="normal"><a href="#__codelineno-0-930">930</a></span>
<span class="normal"><a href="#__codelineno-0-931">931</a></span>
<span class="normal"><a href="#__codelineno-0-932">932</a></span>
<span class="normal"><a href="#__codelineno-0-933">933</a></span>
<span class="normal"><a href="#__codelineno-0-934">934</a></span>
<span class="normal"><a href="#__codelineno-0-935">935</a></span>
<span class="normal"><a href="#__codelineno-0-936">936</a></span>
<span class="normal"><a href="#__codelineno-0-937">937</a></span>
<span class="normal"><a href="#__codelineno-0-938">938</a></span>
<span class="normal"><a href="#__codelineno-0-939">939</a></span>
<span class="normal"><a href="#__codelineno-0-940">940</a></span>
<span class="normal"><a href="#__codelineno-0-941">941</a></span>
<span class="normal"><a href="#__codelineno-0-942">942</a></span>
<span class="normal"><a href="#__codelineno-0-943">943</a></span>
<span class="normal"><a href="#__codelineno-0-944">944</a></span>
<span class="normal"><a href="#__codelineno-0-945">945</a></span>
<span class="normal"><a href="#__codelineno-0-946">946</a></span>
<span class="normal"><a href="#__codelineno-0-947">947</a></span>
<span class="normal"><a href="#__codelineno-0-948">948</a></span>
<span class="normal"><a href="#__codelineno-0-949">949</a></span>
<span class="normal"><a href="#__codelineno-0-950">950</a></span>
<span class="normal"><a href="#__codelineno-0-951">951</a></span>
<span class="normal"><a href="#__codelineno-0-952">952</a></span>
<span class="normal"><a href="#__codelineno-0-953">953</a></span>
<span class="normal"><a href="#__codelineno-0-954">954</a></span>
<span class="normal"><a href="#__codelineno-0-955">955</a></span>
<span class="normal"><a href="#__codelineno-0-956">956</a></span>
<span class="normal"><a href="#__codelineno-0-957">957</a></span>
<span class="normal"><a href="#__codelineno-0-958">958</a></span>
<span class="normal"><a href="#__codelineno-0-959">959</a></span>
<span class="normal"><a href="#__codelineno-0-960">960</a></span>
<span class="normal"><a href="#__codelineno-0-961">961</a></span>
<span class="normal"><a href="#__codelineno-0-962">962</a></span>
<span class="normal"><a href="#__codelineno-0-963">963</a></span>
<span class="normal"><a href="#__codelineno-0-964">964</a></span>
<span class="normal"><a href="#__codelineno-0-965">965</a></span>
<span class="normal"><a href="#__codelineno-0-966">966</a></span>
<span class="normal"><a href="#__codelineno-0-967">967</a></span>
<span class="normal"><a href="#__codelineno-0-968">968</a></span>
<span class="normal"><a href="#__codelineno-0-969">969</a></span>
<span class="normal"><a href="#__codelineno-0-970">970</a></span>
<span class="normal"><a href="#__codelineno-0-971">971</a></span>
<span class="normal"><a href="#__codelineno-0-972">972</a></span>
<span class="normal"><a href="#__codelineno-0-973">973</a></span>
<span class="normal"><a href="#__codelineno-0-974">974</a></span>
<span class="normal"><a href="#__codelineno-0-975">975</a></span>
<span class="normal"><a href="#__codelineno-0-976">976</a></span>
<span class="normal"><a href="#__codelineno-0-977">977</a></span>
<span class="normal"><a href="#__codelineno-0-978">978</a></span>
<span class="normal"><a href="#__codelineno-0-979">979</a></span>
<span class="normal"><a href="#__codelineno-0-980">980</a></span>
<span class="normal"><a href="#__codelineno-0-981">981</a></span>
<span class="normal"><a href="#__codelineno-0-982">982</a></span>
<span class="normal"><a href="#__codelineno-0-983">983</a></span>
<span class="normal"><a href="#__codelineno-0-984">984</a></span>
<span class="normal"><a href="#__codelineno-0-985">985</a></span>
<span class="normal"><a href="#__codelineno-0-986">986</a></span>
<span class="normal"><a href="#__codelineno-0-987">987</a></span>
<span class="normal"><a href="#__codelineno-0-988">988</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cm">/**</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="cm"> * \file linear_octree.c</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="cm"> * \brief Implementation of linear octree for Barnes-Hut algorithm</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="cm"> * </span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="cm"> * \author Ching-Yin Ng</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="cm"> */</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="cp">#ifdef USE_OPENMP</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="cp">#endif</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;acceleration.h&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;common.h&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;error.h&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;linear_octree.h&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="c1">// // For debug only</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="c1">// IN_FILE void print_octree_nodes(</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="c1">//     const LinearOctree *restrict octree,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="c1">//     const double *restrict x,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="c1">//     const double *restrict m,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="c1">//     const int node_idx,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="c1">//     const int indent</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="c1">// )</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="c1">// {</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="c1">//     // Print indent spaces</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="c1">//     for (int i = 0; i &lt; indent; ++i)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="c1">//     printf(&quot;  &quot;);</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="c1">//     // Print summary info about the node</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="c1">//     printf(&quot;Node %d:\n&quot;, node_idx);</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="c1">//     for (int i = 0; i &lt; indent; ++i) printf(&quot;  &quot;);</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="c1">//     printf(&quot;  Num Particles: %d, Num children: %d\n&quot;,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="c1">//         octree-&gt;tree_num_particles[node_idx],</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="c1">//         octree-&gt;tree_num_internal_children[node_idx]</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="c1">//     );</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="c1">//     if (octree-&gt;tree_num_internal_children[node_idx] &gt; 0)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="c1">//     {</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="c1">//         for (int i = 0; i &lt; indent; ++i) printf(&quot;  &quot;);</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="c1">//         printf(&quot;  Center of Mass: (%.16g, %.16g, %.16g), Total Mass: %.16g\n&quot;,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="c1">//             octree-&gt;tree_center_of_mass_x[node_idx],</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="c1">//             octree-&gt;tree_center_of_mass_y[node_idx],</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="c1">//             octree-&gt;tree_center_of_mass_z[node_idx],</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="c1">//             octree-&gt;tree_mass[node_idx]</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="c1">//         );</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="c1">//     }</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="c1">//     else</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="c1">//     {</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="c1">//         for (int i = 0; i &lt; octree-&gt;tree_num_particles[node_idx]; i++)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="c1">//         {</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="c1">//             int particle_idx = octree-&gt;sorted_indices[octree-&gt;tree_first_particle_sorted_idx[node_idx] + i];</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="c1">//             for (int j = 0; j &lt; indent; ++j) printf(&quot;  &quot;);</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="c1">//             printf(&quot;  Particle %d: (%.4g, %.4g, %.4g), m = %.4g\n&quot;,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="c1">//                 particle_idx,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="c1">//                 x[particle_idx * 3 + 0],</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="c1">//                 x[particle_idx * 3 + 1],</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="c1">//                 x[particle_idx * 3 + 2],</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="c1">//                 m[particle_idx]</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="c1">//             );</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="c1">//         }</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="c1">//     }</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="c1">//     // Recurse on internal children (if any)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="c1">//     int num_children = octree-&gt;tree_num_internal_children[node_idx];</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="c1">//     if (num_children &gt; 0) </span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="c1">//     {</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="c1">//         int first_child = octree-&gt;tree_first_internal_children_idx[node_idx];</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="c1">//         for (int i = 0; i &lt; num_children; ++i)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="c1">//         {</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="c1">//             int child_idx = first_child + i;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="c1">//             print_octree_nodes(</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="c1">//                 octree,</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="c1">//                 x,</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="c1">//                 m,</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="c1">//                 child_idx,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="c1">//                 indent + 1</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="c1">//             );</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="c1">//         }</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="c1">//     }</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="c1">// }</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="n">LinearOctree</span><span class="w"> </span><span class="nf">get_new_linear_octree</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="p">{</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="w">    </span><span class="n">LinearOctree</span><span class="w"> </span><span class="n">linear_octree</span><span class="p">;</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="w">    </span><span class="n">linear_octree</span><span class="p">.</span><span class="n">particle_morton_indices_deepest_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="w">    </span><span class="n">linear_octree</span><span class="p">.</span><span class="n">sorted_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="w">    </span><span class="n">linear_octree</span><span class="p">.</span><span class="n">tree_num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="w">    </span><span class="n">linear_octree</span><span class="p">.</span><span class="n">tree_num_internal_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="w">    </span><span class="n">linear_octree</span><span class="p">.</span><span class="n">tree_first_internal_children_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="w">    </span><span class="n">linear_octree</span><span class="p">.</span><span class="n">tree_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="w">    </span><span class="n">linear_octree</span><span class="p">.</span><span class="n">tree_center_of_mass_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="w">    </span><span class="n">linear_octree</span><span class="p">.</span><span class="n">tree_center_of_mass_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="w">    </span><span class="n">linear_octree</span><span class="p">.</span><span class="n">tree_center_of_mass_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">linear_octree</span><span class="p">;</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="p">}</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="cm">/**</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="cm"> * \brief Calculate the bounding box of the system</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="cm"> * </span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="cm"> * \param[out] center 3D vector of the center of the bounding box</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="cm"> * \param[out] width Width of the bounding box</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="cm"> * \param[in] num_particles Number of particles</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="cm"> * \param[in] x Array of position vectors</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="cm"> */</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="n">IN_FILE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">calculate_bounding_box</span><span class="p">(</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">center</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">width</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_particles</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">x</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="p">{</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="w">    </span><span class="cm">/* Find the width of the bounding box */</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">min_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">max_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">min_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">max_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">min_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">max_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_particles</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="w">        </span><span class="n">min_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmin</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="w">        </span><span class="n">max_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmax</span><span class="p">(</span><span class="n">max_x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="w">        </span><span class="n">min_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmin</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="w">        </span><span class="n">max_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmax</span><span class="p">(</span><span class="n">max_y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="w">        </span><span class="n">min_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmin</span><span class="p">(</span><span class="n">min_z</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]);</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="w">        </span><span class="n">max_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmax</span><span class="p">(</span><span class="n">max_z</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]);</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="w">    </span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">max_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">min_x</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="w">    </span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">max_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">min_y</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="w">    </span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">max_z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">min_z</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">width_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min_x</span><span class="p">;</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">width_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min_y</span><span class="p">;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">width_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min_z</span><span class="p">;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="w">    </span><span class="o">*</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmax</span><span class="p">(</span><span class="n">fmax</span><span class="p">(</span><span class="n">width_x</span><span class="p">,</span><span class="w"> </span><span class="n">width_y</span><span class="p">),</span><span class="w"> </span><span class="n">width_z</span><span class="p">);</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="p">}</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="cm">/**</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="cm"> * \brief Compute the 3D Morton indices at level 21 using magic number</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="cm"> * </span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="cm"> * \param[out] morton_indices Array of Morton indices</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="cm"> * \param[in] object_count Number of particles</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="cm"> * \param[in] x Array of position vectors</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="cm"> * \param[in] center 3D vector of the center of the bounding box</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="cm"> * \param[in] width Width of the bounding box</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="cm"> * </span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="cm"> * \ref https://stackoverflow.com/a/18528775, Stack Overflow</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="cm"> */</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="n">IN_FILE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">compute_3d_particle_morton_indices_deepest_level</span><span class="p">(</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="w">    </span><span class="n">int64</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">morton_indices</span><span class="p">,</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">object_count</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">x</span><span class="p">,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">center</span><span class="p">,</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">width</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="p">{</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">object_count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="w">        </span><span class="cm">/* Normalize the position */</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">x_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">y_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">z_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="w">        </span><span class="cm">/* Compute the morton indices */</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="w">        </span><span class="n">int64</span><span class="w"> </span><span class="n">n_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">21</span><span class="p">);</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="w">        </span><span class="n">int64</span><span class="w"> </span><span class="n">n_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">21</span><span class="p">);</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="w">        </span><span class="n">int64</span><span class="w"> </span><span class="n">n_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">21</span><span class="p">);</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="w">        </span><span class="n">n_x</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x1fffff</span><span class="p">;</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="w">        </span><span class="n">n_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_x</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f00000000ffff</span><span class="p">;</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="w">        </span><span class="n">n_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_x</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f0000ff0000ff</span><span class="p">;</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="w">        </span><span class="n">n_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_x</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x100f00f00f00f00f</span><span class="p">;</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="w">        </span><span class="n">n_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_x</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x10c30c30c30c30c3</span><span class="p">;</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="w">        </span><span class="n">n_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_x</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1249249249249249</span><span class="p">;</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="w">        </span><span class="n">n_y</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x1fffff</span><span class="p">;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="w">        </span><span class="n">n_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_y</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f00000000ffff</span><span class="p">;</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="w">        </span><span class="n">n_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_y</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f0000ff0000ff</span><span class="p">;</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="w">        </span><span class="n">n_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_y</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x100f00f00f00f00f</span><span class="p">;</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="w">        </span><span class="n">n_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_y</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x10c30c30c30c30c3</span><span class="p">;</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="w">        </span><span class="n">n_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_y</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1249249249249249</span><span class="p">;</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="w">        </span><span class="n">n_z</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x1fffff</span><span class="p">;</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="w">        </span><span class="n">n_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_z</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_z</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f00000000ffff</span><span class="p">;</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="w">        </span><span class="n">n_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_z</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_z</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f0000ff0000ff</span><span class="p">;</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="w">        </span><span class="n">n_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_z</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_z</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x100f00f00f00f00f</span><span class="p">;</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="w">        </span><span class="n">n_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_z</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_z</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x10c30c30c30c30c3</span><span class="p">;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="w">        </span><span class="n">n_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_z</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n_z</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1249249249249249</span><span class="p">;</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="w">        </span><span class="n">morton_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_x</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">n_y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">n_z</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="p">}</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="cm">/**</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="cm"> * \brief Perform radix sort on the particles based on their Morton indices</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="cm"> * </span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="cm"> * \param morton_indices Array of Morton indices</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="cm"> * \param indices Array of indices</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="cm"> * \param object_count Number of particles</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="cm"> * \param level Level of the Morton indices</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="cm"> * </span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="cm"> * \return ErrorStatus</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="cm"> * </span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="cm"> * \exception GRAV_MEMORY_ERROR if memory allocation for temporary arrays failed</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="cm"> */</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="n">IN_FILE</span><span class="w"> </span><span class="n">ErrorStatus</span><span class="w"> </span><span class="n">radix_sort_particles_morton_index</span><span class="p">(</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="w">    </span><span class="n">int64</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">morton_indices</span><span class="p">,</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">indices</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">object_count</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="p">{</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="w">    </span><span class="cm">/* Calculate constnats */</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RADIX_BITS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RADIX_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">RADIX_BITS</span><span class="p">;</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RADIX_MASK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RADIX_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_significant_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">level</span><span class="p">;</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_passes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">num_significant_bits</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">RADIX_BITS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">RADIX_BITS</span><span class="p">;</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a><span class="w">    </span><span class="cm">/* Allocate memory */</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="w">    </span><span class="n">int64</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">temp_morton_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">object_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">int64</span><span class="p">));</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">temp_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">object_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">RADIX_SIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">temp_morton_indices</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">temp_indices</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">temp_morton_indices</span><span class="p">);</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">temp_indices</span><span class="p">);</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="w">            </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="w">            </span><span class="s">&quot;Failed to allocate memory for temporary arrays&quot;</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="w">    </span><span class="cm">/* Perform LSB radix sort */</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="w">    </span><span class="c1">// Flag to indicate whether the sorted array is in temp arrays</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="w">    </span><span class="c1">// This can reduce the number of memcpy to O(1) instead of O(num_passes)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_passes</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="w">        </span><span class="c1">// Empty count array</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">RADIX_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="w">            </span><span class="n">count</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="w">        </span><span class="c1">// Calculate shift for this pass (start from least significant bits)</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">shift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">RADIX_BITS</span><span class="p">;</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="w">        </span><span class="c1">// Count occurrences of each radix value</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_temp</span><span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">object_count</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="w">                </span><span class="n">count</span><span class="p">[(</span><span class="n">temp_morton_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">shift</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">RADIX_MASK</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">object_count</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="w">                </span><span class="n">count</span><span class="p">[(</span><span class="n">morton_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">shift</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">RADIX_MASK</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="w">        </span><span class="c1">// Get cumulative count</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">RADIX_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">old_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="w">            </span><span class="n">count</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">total</span><span class="p">;</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="w">            </span><span class="n">total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">old_count</span><span class="p">;</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="w">        </span><span class="c1">// Sort elements into temporary arrays</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_temp</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">object_count</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">[(</span><span class="n">temp_morton_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">shift</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">RADIX_MASK</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="w">                </span><span class="n">morton_indices</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_morton_indices</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="w">                </span><span class="n">indices</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_indices</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">object_count</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">[(</span><span class="n">morton_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">shift</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">RADIX_MASK</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="w">                </span><span class="n">temp_morton_indices</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">morton_indices</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="w">                </span><span class="n">temp_indices</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">indices</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="w">        </span><span class="n">is_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">is_temp</span><span class="p">;</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="w">    </span><span class="c1">// Copy the sorted array to the original array</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_temp</span><span class="p">)</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">morton_indices</span><span class="p">,</span><span class="w"> </span><span class="n">temp_morton_indices</span><span class="p">,</span><span class="w"> </span><span class="n">object_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">int64</span><span class="p">));</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="w"> </span><span class="n">temp_indices</span><span class="p">,</span><span class="w"> </span><span class="n">object_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">temp_morton_indices</span><span class="p">);</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">temp_indices</span><span class="p">);</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">make_success_error_status</span><span class="p">();</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="p">}</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="cm">/**</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="cm"> * \brief Perform binary search to find the number of particles in each octant</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="cm"> * </span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="cm"> * \param[out] num_particles_per_octant Array to store the number of particles in each octant</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="cm"> * \param[in] particle_morton_indices_deepest_level Array of Morton indices at the deepest level</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="cm"> * \param[in] node_morton_index_level Morton index of the node</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="cm"> * \param[in] start_idx Start index of the particles in the node</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="cm"> * \param[in] end_idx End index of the particles in the node</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="cm"> * \param[in] leaf_level Level of the leaf nodes</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="cm"> * </span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="cm"> * \return ErrorStatus</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="cm"> * </span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="cm"> * \exception GRAV_VALUE_ERROR if the Morton index is out of range</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="cm"> */</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="n">IN_FILE</span><span class="w"> </span><span class="n">ErrorStatus</span><span class="w"> </span><span class="n">binary_search_num_particles_per_octant</span><span class="p">(</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">num_particles_per_octant</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">int64</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">particle_morton_indices_deepest_level</span><span class="p">,</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">int64</span><span class="w"> </span><span class="n">node_morton_index_level</span><span class="p">,</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">start_idx</span><span class="p">,</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">end_idx</span><span class="p">,</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">leaf_level</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="p">)</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="p">{</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">int64</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_morton_index_level</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">level_shift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">MORTON_MAX_LEVEL</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">leaf_level</span><span class="p">);</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cumulative_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="w">        </span><span class="c1">// Binary search for the index of last i</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cumulative_count</span><span class="p">;</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end_idx</span><span class="p">;</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">right</span><span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">right</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">left</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mid_octant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">particle_morton_indices_deepest_level</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">level_shift</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prefix</span><span class="p">);</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mid_octant</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">mid_octant</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">raise_error_fmt</span><span class="p">(</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="w">                    </span><span class="n">__FILE__</span><span class="p">,</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="w">                    </span><span class="n">__LINE__</span><span class="p">,</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="w">                    </span><span class="n">__func__</span><span class="p">,</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="w">                    </span><span class="n">GRAV_VALUE_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="w">                    </span><span class="s">&quot;Morton index %d is out of range [0, 7]&quot;</span><span class="p">,</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="w">                    </span><span class="n">mid_octant</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="w">                </span><span class="p">);</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mid_octant</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">mid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">end_idx</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(((</span><span class="n">particle_morton_indices_deepest_level</span><span class="p">[</span><span class="n">mid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">level_shift</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prefix</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">i</span><span class="p">))</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="w">                </span><span class="n">num_particles_per_octant</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">start_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cumulative_count</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="w">                </span><span class="n">cumulative_count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">num_particles_per_octant</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mid_octant</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="w">                </span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="w">            </span><span class="k">else</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="w">                </span><span class="n">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">make_success_error_status</span><span class="p">();</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="p">}</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="cm">/**</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="cm"> * \brief Set up a new internal node</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="cm"> * </span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="cm"> * \param[out] octree Pointer to the linear octree</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a><span class="cm"> * \param[out] allocated_internal_nodes_ptr Pointer to the number of allocated internal nodes</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="cm"> * \param[in] level Node level</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="cm"> * \param[in] node Node index</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="cm"> * \param[in] node_morton_index_level Morton index of the node at the current level</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a><span class="cm"> * </span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a><span class="cm"> * \return ErrorStatus</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="cm"> */</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="n">IN_FILE</span><span class="w"> </span><span class="n">ErrorStatus</span><span class="w"> </span><span class="n">setup_node</span><span class="p">(</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="w">    </span><span class="n">LinearOctree</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">octree</span><span class="p">,</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">allocated_internal_nodes_ptr</span><span class="p">,</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="p">,</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">node</span><span class="p">,</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">int64</span><span class="w"> </span><span class="n">node_morton_index_level</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="p">)</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a><span class="p">{</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="w">    </span><span class="n">ErrorStatus</span><span class="w"> </span><span class="n">error_status</span><span class="p">;</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a><span class="w">    </span><span class="cm">/* Declare variables */</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">num_internal_nodes_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">num_internal_nodes</span><span class="p">;</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_particles</span><span class="p">;</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_num_internal_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_internal_children</span><span class="p">;</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_first_particle_sorted_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_particle_sorted_idx</span><span class="p">;</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_first_internal_children_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_internal_children_idx</span><span class="p">;</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_mass</span><span class="p">;</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_center_of_mass_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_x</span><span class="p">;</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_center_of_mass_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_y</span><span class="p">;</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_center_of_mass_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_z</span><span class="p">;</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">num_particles_per_octant</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a><span class="w">    </span><span class="cm">/* Find the number of particles in each octant */</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">start_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree_first_particle_sorted_idx</span><span class="p">[</span><span class="n">node</span><span class="p">];</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">end_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tree_num_particles</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">child_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a><span class="w">    </span><span class="n">error_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRAP_TRACEBACK</span><span class="p">(</span><span class="n">binary_search_num_particles_per_octant</span><span class="p">(</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a><span class="w">        </span><span class="n">num_particles_per_octant</span><span class="p">,</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">particle_morton_indices_deepest_level</span><span class="p">,</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="w">        </span><span class="n">node_morton_index_level</span><span class="p">,</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="w">        </span><span class="n">start_idx</span><span class="p">,</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="w">        </span><span class="n">end_idx</span><span class="p">,</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="w">        </span><span class="n">child_level</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="w">    </span><span class="p">));</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error_status</span><span class="p">.</span><span class="n">return_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GRAV_SUCCESS</span><span class="p">)</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_status</span><span class="p">;</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="w">    </span><span class="cm">/* Set up child nodes */</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">first_child_found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cumulative_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_particles_per_octant</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">num_internal_nodes_ptr</span><span class="p">;</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="w">        </span><span class="c1">// Reallocate memory if necessary</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">child</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">*</span><span class="n">allocated_internal_nodes_ptr</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="w">            </span><span class="o">*</span><span class="n">allocated_internal_nodes_ptr</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">tmp_tree_num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">tree_num_particles</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">allocated_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_num_particles</span><span class="p">)</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="w">                    </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a><span class="w">                    </span><span class="s">&quot;Failed to reallocate memory for tree_num_particles&quot;</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="w">                </span><span class="p">);</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a><span class="w">            </span><span class="n">tree_num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_num_particles</span><span class="p">;</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="w">            </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree_num_particles</span><span class="p">;</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">tmp_tree_num_internal_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">tree_num_internal_children</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">allocated_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_num_internal_children</span><span class="p">)</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a><span class="w">                    </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a><span class="w">                    </span><span class="s">&quot;Failed to reallocate memory for tree_num_internal_children&quot;</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a><span class="w">                </span><span class="p">);</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a><span class="w">            </span><span class="n">tree_num_internal_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_num_internal_children</span><span class="p">;</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a><span class="w">            </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_internal_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree_num_internal_children</span><span class="p">;</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">tmp_tree_first_particle_sorted_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">tree_first_particle_sorted_idx</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">allocated_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_first_particle_sorted_idx</span><span class="p">)</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a><span class="w">                    </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a><span class="w">                    </span><span class="s">&quot;Failed to reallocate memory for tree_first_particle_sorted_idx&quot;</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a><span class="w">                </span><span class="p">);</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a><span class="w">            </span><span class="n">tree_first_particle_sorted_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_first_particle_sorted_idx</span><span class="p">;</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="w">            </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_particle_sorted_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree_first_particle_sorted_idx</span><span class="p">;</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">tmp_tree_first_internal_children_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">tree_first_internal_children_idx</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">allocated_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_first_internal_children_idx</span><span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a><span class="w">                    </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a><span class="w">                    </span><span class="s">&quot;Failed to reallocate memory for tree_first_internal_children_idx&quot;</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a><span class="w">                </span><span class="p">);</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a><span class="w">            </span><span class="n">tree_first_internal_children_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_first_internal_children_idx</span><span class="p">;</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a><span class="w">            </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_internal_children_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree_first_internal_children_idx</span><span class="p">;</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">tmp_tree_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_mass</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">allocated_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_mass</span><span class="p">)</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a><span class="w">                    </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="w">                    </span><span class="s">&quot;Failed to reallocate memory for tree_mass&quot;</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a><span class="w">                </span><span class="p">);</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a><span class="w">            </span><span class="n">tree_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_mass</span><span class="p">;</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a><span class="w">            </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_mass</span><span class="p">;</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">tmp_tree_center_of_mass_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_x</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">allocated_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_center_of_mass_x</span><span class="p">)</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a><span class="w">                    </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a><span class="w">                    </span><span class="s">&quot;Failed to reallocate memory for tree_center_of_mass_x&quot;</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a><span class="w">                </span><span class="p">);</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a><span class="w">            </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_center_of_mass_x</span><span class="p">;</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a><span class="w">            </span><span class="n">tree_center_of_mass_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_center_of_mass_x</span><span class="p">;</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">tmp_tree_center_of_mass_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_y</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">allocated_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_center_of_mass_y</span><span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a><span class="w">                    </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a><span class="w">                    </span><span class="s">&quot;Failed to reallocate memory for tree_center_of_mass_y&quot;</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="w">                </span><span class="p">);</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a><span class="w">            </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_center_of_mass_y</span><span class="p">;</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a><span class="w">            </span><span class="n">tree_center_of_mass_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_center_of_mass_y</span><span class="p">;</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">tmp_tree_center_of_mass_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_z</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">allocated_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_center_of_mass_z</span><span class="p">)</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a><span class="w">                    </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a><span class="w">                    </span><span class="s">&quot;Failed to reallocate memory for tree_center_of_mass_z&quot;</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a><span class="w">                </span><span class="p">);</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="w">            </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_center_of_mass_z</span><span class="p">;</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="w">            </span><span class="n">tree_center_of_mass_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_center_of_mass_z</span><span class="p">;</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">first_child_found</span><span class="p">)</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="w">            </span><span class="n">first_child_found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="w">            </span><span class="n">tree_first_internal_children_idx</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">child</span><span class="p">;</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a><span class="w">            </span><span class="n">tree_num_internal_children</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><span class="w">        </span><span class="c1">// Create a new internal node</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a><span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">num_internal_nodes_ptr</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a><span class="w">        </span><span class="p">(</span><span class="n">tree_num_internal_children</span><span class="p">[</span><span class="n">node</span><span class="p">])</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a><span class="w">        </span><span class="n">tree_num_internal_children</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a><span class="w">        </span><span class="n">tree_num_particles</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_particles_per_octant</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a><span class="w">        </span><span class="n">tree_first_particle_sorted_idx</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cumulative_count</span><span class="p">;</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a><span class="w">        </span><span class="n">tree_mass</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a><span class="w">        </span><span class="n">tree_center_of_mass_x</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a><span class="w">        </span><span class="n">tree_center_of_mass_y</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a><span class="w">        </span><span class="n">tree_center_of_mass_z</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a><span class="w">        </span><span class="n">cumulative_count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">num_particles_per_octant</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">make_success_error_status</span><span class="p">();</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a><span class="p">}</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="cm">/**</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a><span class="cm"> * \brief Helper function to construct the octree</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a><span class="cm"> * </span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a><span class="cm"> * \param[out] octree Pointer to the linear octree</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a><span class="cm"> * \param[in] allocated_internal_nodes Number of allocated internal nodes</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a><span class="cm"> * \param[in] max_num_particles_per_leaf Maximum number of particles per leaf</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a><span class="cm"> * \param[in] num_particles Number of particles</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a><span class="cm"> * \param[in] x Array of position vectors</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><span class="cm"> * \param[in] m Array of masses</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="cm"> * </span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="cm"> * \return ErrorStatus</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="cm"> */</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="n">IN_FILE</span><span class="w"> </span><span class="n">ErrorStatus</span><span class="w"> </span><span class="n">helper_construct_octree</span><span class="p">(</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="w">    </span><span class="n">LinearOctree</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">octree</span><span class="p">,</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">allocated_internal_nodes</span><span class="p">,</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_num_particles_per_leaf</span><span class="p">,</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_particles</span><span class="p">,</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">x</span><span class="p">,</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">m</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a><span class="p">)</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><span class="p">{</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Stack</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">node</span><span class="p">;</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">processed_children</span><span class="p">;</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">total_mass</span><span class="p">;</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">Stack</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">Stack</span><span class="p">;</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a><span class="w">    </span><span class="n">ErrorStatus</span><span class="w"> </span><span class="n">error_status</span><span class="p">;</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a><span class="w">    </span><span class="cm">/* Create a stack */</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a><span class="w">    </span><span class="n">Stack</span><span class="w"> </span><span class="n">stack</span><span class="p">[</span><span class="n">MORTON_MAX_LEVEL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a><span class="w">    </span><span class="n">Stack</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">current_stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a><span class="w">    </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a><span class="w">    </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a><span class="w">    </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">total_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a><span class="w">    </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a><span class="w">    </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a><span class="w">    </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a><span class="w">    </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="w">    </span><span class="cm">/* Declare variables */</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">num_internal_nodes_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">num_internal_nodes</span><span class="p">);</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">int64</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">particle_morton_indices_deepest_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">particle_morton_indices_deepest_level</span><span class="p">;</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">sorted_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">sorted_indices</span><span class="p">;</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a><span class="w">    </span><span class="cm">/* Set up the root node */</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="w">    </span><span class="o">*</span><span class="n">num_internal_nodes_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_particles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_particles</span><span class="p">;</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_internal_children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_particle_sorted_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_mass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><span class="w">    </span><span class="n">error_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRAP_TRACEBACK</span><span class="p">(</span><span class="n">setup_node</span><span class="p">(</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="w">        </span><span class="n">octree</span><span class="p">,</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">allocated_internal_nodes</span><span class="p">,</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a><span class="w">        </span><span class="n">level</span><span class="p">,</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a><span class="w">        </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a><span class="w">        </span><span class="mi">0</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a><span class="w">    </span><span class="p">));</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error_status</span><span class="p">.</span><span class="n">return_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GRAV_SUCCESS</span><span class="p">)</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_status</span><span class="p">;</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a><span class="w">    </span><span class="n">level</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">current_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_internal_children</span><span class="p">[</span><span class="n">current_node</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_internal_children_idx</span><span class="p">[</span><span class="n">current_node</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">start_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_particle_sorted_idx</span><span class="p">[</span><span class="n">child</span><span class="p">];</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_particles</span><span class="p">[</span><span class="n">child</span><span class="p">];</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a><span class="w">            </span><span class="cm">/* Leaf node */</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_particles</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">max_num_particles_per_leaf</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MORTON_MAX_LEVEL</span><span class="p">)</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a><span class="w">                </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_internal_children</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a><span class="w">                </span><span class="c1">// Update the stack</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_particles</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particle_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sorted_indices</span><span class="p">[</span><span class="n">start_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a><span class="w">                    </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">total_mass</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">particle_idx</span><span class="p">];</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a><span class="w">                    </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">particle_idx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">particle_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a><span class="w">                    </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">particle_idx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">particle_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a><span class="w">                    </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">particle_idx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">particle_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a><span class="w">                </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a><span class="w">            </span><span class="cm">/* Internal node */</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a><span class="w">            </span><span class="k">else</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">int64</span><span class="w"> </span><span class="n">child_morton_index_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">particle_morton_indices_deepest_level</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">MORTON_MAX_LEVEL</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">level</span><span class="p">)));</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a><span class="w">                </span><span class="n">error_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRAP_TRACEBACK</span><span class="p">(</span><span class="n">setup_node</span><span class="p">(</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a><span class="w">                    </span><span class="n">octree</span><span class="p">,</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a><span class="w">                    </span><span class="o">&amp;</span><span class="n">allocated_internal_nodes</span><span class="p">,</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a><span class="w">                    </span><span class="n">level</span><span class="p">,</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a><span class="w">                    </span><span class="n">child</span><span class="p">,</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a><span class="w">                    </span><span class="n">child_morton_index_level</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a><span class="w">                </span><span class="p">));</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error_status</span><span class="p">.</span><span class="n">return_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GRAV_SUCCESS</span><span class="p">)</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">error_status</span><span class="p">;</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a><span class="w">                </span><span class="n">Stack</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">new_item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">level</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a><span class="w">                </span><span class="n">new_item</span><span class="o">-&gt;</span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">child</span><span class="p">;</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a><span class="w">                </span><span class="n">new_item</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a><span class="w">                </span><span class="n">new_item</span><span class="o">-&gt;</span><span class="n">total_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a><span class="w">                </span><span class="n">new_item</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a><span class="w">                </span><span class="n">new_item</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a><span class="w">                </span><span class="n">new_item</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a><span class="w">                </span><span class="n">new_item</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_stack</span><span class="p">;</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a><span class="w">                </span><span class="n">current_stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_item</span><span class="p">;</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a><span class="w">                </span><span class="n">level</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a><span class="w">        </span><span class="cm">/* Processed all children */</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_internal_children</span><span class="p">[</span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">])</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a><span class="w">            </span><span class="cm">/* Update center of mass */</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a><span class="w">            </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_mass</span><span class="p">[</span><span class="n">current_node</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">total_mass</span><span class="p">;</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a><span class="w">            </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_x</span><span class="p">[</span><span class="n">current_node</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">total_mass</span><span class="p">;</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a><span class="w">            </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_y</span><span class="p">[</span><span class="n">current_node</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">total_mass</span><span class="p">;</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a><span class="w">            </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_z</span><span class="p">[</span><span class="n">current_node</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">total_mass</span><span class="p">;</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a><span class="w">            </span><span class="n">Stack</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="p">)</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a><span class="w">            </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">total_mass</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">total_mass</span><span class="p">;</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a><span class="w">            </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a><span class="w">            </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a><span class="w">            </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">mass_times_distance</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a><span class="w">            </span><span class="n">current_stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="p">;</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a><span class="w">            </span><span class="p">(</span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a><span class="w">            </span><span class="n">level</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a><span class="w">    </span><span class="cm">/* Release unused memory */</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">allocated_internal_nodes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">num_internal_nodes_ptr</span><span class="p">))</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tmp_tree_num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_particles</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">num_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_num_particles</span><span class="p">)</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a><span class="w">                </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a><span class="w">                </span><span class="s">&quot;Failed to reallocate memory for tree_num_particles&quot;</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a><span class="w">            </span><span class="p">);</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_num_particles</span><span class="p">;</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tmp_tree_num_internal_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_internal_children</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">num_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_num_internal_children</span><span class="p">)</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a><span class="w">                </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a><span class="w">                </span><span class="s">&quot;Failed to reallocate memory for tree_num_internal_children&quot;</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a><span class="w">            </span><span class="p">);</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_internal_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_num_internal_children</span><span class="p">;</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tmp_tree_first_particle_sorted_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_particle_sorted_idx</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">num_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_first_particle_sorted_idx</span><span class="p">)</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a><span class="w">                </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a><span class="w">                </span><span class="s">&quot;Failed to reallocate memory for tree_first_particle_sorted_idx&quot;</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a><span class="w">            </span><span class="p">);</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_particle_sorted_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_first_particle_sorted_idx</span><span class="p">;</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tmp_tree_first_internal_children_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_internal_children_idx</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">num_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_first_internal_children_idx</span><span class="p">)</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a><span class="w">                </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a><span class="w">                </span><span class="s">&quot;Failed to reallocate memory for tree_first_internal_children_idx&quot;</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a><span class="w">            </span><span class="p">);</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_internal_children_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_first_internal_children_idx</span><span class="p">;</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tmp_tree_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_mass</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">num_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_mass</span><span class="p">)</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a><span class="w">                </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a><span class="w">                </span><span class="s">&quot;Failed to reallocate memory for tree_mass&quot;</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a><span class="w">            </span><span class="p">);</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_mass</span><span class="p">;</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tmp_tree_center_of_mass_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_x</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">num_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_center_of_mass_x</span><span class="p">)</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a><span class="w">                </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a><span class="w">                </span><span class="s">&quot;Failed to reallocate memory for tree_center_of_mass_x&quot;</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a><span class="w">            </span><span class="p">);</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_center_of_mass_x</span><span class="p">;</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tmp_tree_center_of_mass_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_y</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">num_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_center_of_mass_y</span><span class="p">)</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a><span class="w">                </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a><span class="w">                </span><span class="s">&quot;Failed to reallocate memory for tree_center_of_mass_y&quot;</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a><span class="w">            </span><span class="p">);</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_center_of_mass_y</span><span class="p">;</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tmp_tree_center_of_mass_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_z</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">num_internal_nodes_ptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tmp_tree_center_of_mass_z</span><span class="p">)</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a><span class="w">                </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a><span class="w">                </span><span class="s">&quot;Failed to reallocate memory for tree_center_of_mass_z&quot;</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a><span class="w">            </span><span class="p">);</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_tree_center_of_mass_z</span><span class="p">;</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">make_success_error_status</span><span class="p">();</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a><span class="p">}</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a><span class="n">WIN32DLL_API</span><span class="w"> </span><span class="n">ErrorStatus</span><span class="w"> </span><span class="n">construct_octree</span><span class="p">(</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a><span class="w">    </span><span class="n">LinearOctree</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">octree</span><span class="p">,</span>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">system</span><span class="p">,</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">AccelerationParam</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">acceleration_param</span><span class="p">,</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">box_center</span><span class="p">,</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">box_width</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a><span class="p">)</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a><span class="p">{</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a><span class="w">    </span><span class="n">ErrorStatus</span><span class="w"> </span><span class="n">error_status</span><span class="p">;</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a><span class="w">    </span><span class="cm">/* Check for pointers */</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">octree</span><span class="p">)</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span><span class="n">GRAV_POINTER_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Octree pointer is NULL&quot;</span><span class="p">);</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">system</span><span class="p">)</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span><span class="n">GRAV_POINTER_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;System pointer is NULL&quot;</span><span class="p">);</span>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">acceleration_param</span><span class="p">)</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span><span class="n">GRAV_POINTER_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Acceleration parameter pointer is NULL&quot;</span><span class="p">);</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">system</span><span class="o">-&gt;</span><span class="n">num_particles</span><span class="p">;</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">system</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">system</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_num_particles_per_leaf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acceleration_param</span><span class="o">-&gt;</span><span class="n">max_num_particles_per_leaf</span><span class="p">;</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a><span class="w">    </span><span class="cm">/* Find the width and center of the bounding box */</span>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">box_center</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">box_width</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a><span class="w">        </span><span class="n">calculate_bounding_box</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">box_width</span><span class="p">),</span><span class="w"> </span><span class="n">num_particles</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a><span class="w">        </span><span class="n">box_center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">center</span><span class="p">;</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">box_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">box_width</span><span class="p">;</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a><span class="w">        </span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">box_center</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a><span class="w">        </span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">box_center</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a><span class="w">        </span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">box_center</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a><span class="w">    </span><span class="cm">/* Allocate memory */</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a><span class="w">    </span><span class="c1">// Indices</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">particle_morton_indices_deepest_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">num_particles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">int64</span><span class="p">));</span>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">sorted_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">num_particles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">particle_morton_indices_deepest_level</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">sorted_indices</span><span class="p">)</span>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a><span class="w">        </span><span class="n">error_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a><span class="w">            </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a><span class="w">            </span><span class="s">&quot;Failed to allocate memory for Morton indices and sorted indices&quot;</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">err_indices_memory_alloc</span><span class="p">;</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a><span class="w">    </span><span class="c1">// Internal nodes</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a><span class="w">    </span><span class="c1">// int allocated_internal_nodes = num_particles * 2 / max_num_particles_per_leaf;</span>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">allocated_internal_nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_particles</span><span class="p">;</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">allocated_internal_nodes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_internal_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">allocated_internal_nodes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_internal_children_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">allocated_internal_nodes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_particle_sorted_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">allocated_internal_nodes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">allocated_internal_nodes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">allocated_internal_nodes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">allocated_internal_nodes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a><span class="w">    </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">allocated_internal_nodes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a><span class="w">        </span><span class="o">!</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_particles</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a><span class="w">        </span><span class="o">!</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_internal_children</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a><span class="w">        </span><span class="o">!</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_internal_children_idx</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a><span class="w">        </span><span class="o">!</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_particle_sorted_idx</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a><span class="w">        </span><span class="o">!</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_mass</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a><span class="w">        </span><span class="o">!</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_x</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a><span class="w">        </span><span class="o">!</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_y</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a><span class="w">        </span><span class="o">!</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_z</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a><span class="w">    </span><span class="p">)</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a><span class="w">        </span><span class="n">error_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRAP_RAISE_ERROR</span><span class="p">(</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a><span class="w">            </span><span class="n">GRAV_MEMORY_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a><span class="w">            </span><span class="s">&quot;Failed to allocate memory for internal nodes&quot;</span>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">err_internal_nodes_memory_alloc</span><span class="p">;</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a><span class="w">    </span><span class="cm">/* Initialize the sorted indices */</span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_particles</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">sorted_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a><span class="w">    </span><span class="cm">/* Compute the 3D Morton indices at level 21 */</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a><span class="w">    </span><span class="n">compute_3d_particle_morton_indices_deepest_level</span><span class="p">(</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">particle_morton_indices_deepest_level</span><span class="p">,</span>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a><span class="w">        </span><span class="n">num_particles</span><span class="p">,</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a><span class="w">        </span><span class="n">x</span><span class="p">,</span>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a><span class="w">        </span><span class="n">center</span><span class="p">,</span>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">box_width</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a><span class="w">    </span><span class="p">);</span>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a><span class="w">    </span><span class="cm">/* Sort the particles based on their Morton indices */</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a><span class="w">    </span><span class="n">error_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRAP_TRACEBACK</span><span class="p">(</span><span class="n">radix_sort_particles_morton_index</span><span class="p">(</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">particle_morton_indices_deepest_level</span><span class="p">,</span>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a><span class="w">        </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">sorted_indices</span><span class="p">,</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a><span class="w">        </span><span class="n">num_particles</span><span class="p">,</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a><span class="w">        </span><span class="n">MORTON_MAX_LEVEL</span>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a><span class="w">    </span><span class="p">));</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error_status</span><span class="p">.</span><span class="n">return_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GRAV_SUCCESS</span><span class="p">)</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">err_radix_sort</span><span class="p">;</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a><span class="w">    </span><span class="cm">/* Construct the octree */</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a><span class="w">    </span><span class="n">error_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRAP_TRACEBACK</span><span class="p">(</span><span class="n">helper_construct_octree</span><span class="p">(</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a><span class="w">        </span><span class="n">octree</span><span class="p">,</span>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a><span class="w">        </span><span class="n">allocated_internal_nodes</span><span class="p">,</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a><span class="w">        </span><span class="n">max_num_particles_per_leaf</span><span class="p">,</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a><span class="w">        </span><span class="n">num_particles</span><span class="p">,</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a><span class="w">        </span><span class="n">x</span><span class="p">,</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a><span class="w">        </span><span class="n">m</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a><span class="w">    </span><span class="p">));</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error_status</span><span class="p">.</span><span class="n">return_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GRAV_SUCCESS</span><span class="p">)</span>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">err_construct_octree</span><span class="p">;</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">make_success_error_status</span><span class="p">();</span>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a><span class="nl">err_construct_octree</span><span class="p">:</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a><span class="nl">err_radix_sort</span><span class="p">:</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a><span class="nl">err_internal_nodes_memory_alloc</span><span class="p">:</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a><span class="nl">err_indices_memory_alloc</span><span class="p">:</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a><span class="w">    </span><span class="n">free_linear_octree</span><span class="p">(</span><span class="n">octree</span><span class="p">);</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error_status</span><span class="p">;</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a><span class="p">}</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a><span class="n">WIN32DLL_API</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">free_linear_octree</span><span class="p">(</span><span class="n">LinearOctree</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">octree</span><span class="p">)</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a><span class="p">{</span>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">particle_morton_indices_deepest_level</span><span class="p">);</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">sorted_indices</span><span class="p">);</span>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_particles</span><span class="p">);</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_internal_children</span><span class="p">);</span>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_particle_sorted_idx</span><span class="p">);</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_internal_children_idx</span><span class="p">);</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_mass</span><span class="p">);</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_x</span><span class="p">);</span>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_y</span><span class="p">);</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_z</span><span class="p">);</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a><span class="p">}</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a><span class="n">WIN32DLL_API</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">linear_octree_check_if_included</span><span class="p">(</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">int64</span><span class="w"> </span><span class="n">morton_index_i</span><span class="p">,</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">int64</span><span class="w"> </span><span class="n">morton_index_j</span><span class="p">,</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a><span class="p">)</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a><span class="p">{</span>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">morton_index_i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">MORTON_MAX_LEVEL</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">level</span><span class="p">)))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">morton_index_j</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">MORTON_MAX_LEVEL</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">level</span><span class="p">)));</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</details>
<figure style="text-align: center;">
  <img src="../../../examples/media/morton_curve.png" alt="Morton curve" width="400" style="display: block; margin: auto;" />
</figure>
<p>Figure 2: Morton curve for Morton index 0 to 7. This is the full curve for level 1,
        or the first <span class="arithmatex">\(\frac{1}{8}\)</span> of the full curve at level 2, etc.</p>
<p>Here, we provide a detailed description on constructing a static linear octree
using only linear arrays and Morton indices.
To build a linear octree, we utilize the idea of Morton code (also known as Z-order
or Morton space filling curve). Figure 2 shows a Morton curve at level 1
of the tree. The Morton index is calculated by encoding the spatial coordinate in binary
format. For example, at level 1 we have <span class="arithmatex">\(x, y, z \in \{0, 1\}\)</span>. For <span class="arithmatex">\(x = 0, y = 0, z = 1\)</span>,
we have the Morton index <span class="arithmatex">\(\underset{z}{1}\underset{y}{0}\underset{x}{0} \textnormal{ (binary)} = 4\)</span>. For <span class="arithmatex">\(x = 1, y = 1, z = 0\)</span>,
we have the Morton index <span class="arithmatex">\(\underset{z}{0}\underset{y}{1}\underset{x}{1} \textnormal{ (binary)} = 3\)</span>.
As we traverse into deeper level, we stack another three bits after the Morton index for each level. 
For example, a particle has a local Morton index 5 at level 1 and local Morton index 3
at level 2. The full Morton index at level 2 is obtained by</p>
<div class="arithmatex">\[\begin{equation}
    %\label{}
    \overset{5}{\overbrace{\underset{z}{1}\underset{y}{0}\underset{x}{1}}}
    \overset{3}{\overbrace{\underset{z}{0}\underset{y}{1}\underset{x}{1}}}
    \textnormal{ (binary)}
    = 43.
\end{equation}\]</div>
<p>Unlike a tree data structure, there is a limit for the depth of the octree. For 64-bit
integer, there can only be <span class="arithmatex">\(\lfloor64 / 3 \rfloor = 21\)</span> levels (excluding level 0) 
as it takes three bits for each level. This could become an issue for exascale simulations,
but this could be resolved by using integers with more bits. </p>
<p>The Morton index could be calculated easily using bit-shift operations and loops.
In our project, we fixed the Morton indices to 64-bit integers by default and uses
magic numbers to compute the Morton indices at level 21 directly without a loop.
The magic numbers are generated using the script by <sup id="fnref:morton_index_stackoverflow"><a class="footnote-ref" href="#fn:morton_index_stackoverflow">2</a></sup>.
Morton index on each level can then be retrieved with bit-shift operations.</p>
<figure style="text-align: center;">
  <img src="../../../examples/media/linear_octree.png" alt="Linear octree" width="800" style="display: block; margin: auto;" />
</figure>
<p>Figure 3: Graphical illustration of linear octree. On the top, there are multiple aligned
        arrays. Each index represent one tree node, and each array represent a piece
        of information stored by the tree node. On below, we have the sorted Morton
        indices and the particle indices sorted with Morton indices.
        Since they are sorted, only the first index and the number of particles are needed
        to obtain the full particle list of each tree node. Tree node 0 is the
        root node with <span class="arithmatex">\(N\)</span> particles. Tree node 1 and 2 are the proper successor of the root node,
        with 4 and 8 particles respectively.</p>
<p>Now, with the knowledge of Morton index, we can construct a linear octree building algorithm.
The tree is represented with multiple aligned arrays, where each index to the arrays
corresponds to one internal node. An illustration of the linear octree is provided in figure 3.</p>
<ol>
<li>Compute the Morton index for all particles at the deepest
    level (level 21 for 64-bit integers)</li>
<li>Sort the Morton index (e.g. radix sort) along with the particle indices, so that
    we have an array of sorted Morton indices, and particle indices
    that corresponds to each Morton index.</li>
<li>For each particle, starts from the root node,<ul>
<li>
<p>Check if there are any particles in the corresponding suboctant of the current node.
    This can be done with binary search of the suboctant's Morton index at that level.
    (The binary search also tells us how many particles are in each child node.)</p>
<ul>
<li>If not, instantiate a new child node for that suboctant by assigning a tree index.
    Backpropogate the mass and coordinate all the way to the root node.</li>
<li>Otherwise, traverse deeper into the child node.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>Side note: We do not know beforehand how many internal nodes there will be.
Therefore, the arrays might become full during construction. By using a dynamic array
(one that doubles in size whenever it is full), we can build an octree with as many internal
nodes as needed.</p>
<h2 id="tree-traversal">Tree traversal</h2>
<details class="note">
<summary>Source code (Click to expand)</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">  1</a></span>
<span class="normal"><a href="#__codelineno-1-2">  2</a></span>
<span class="normal"><a href="#__codelineno-1-3">  3</a></span>
<span class="normal"><a href="#__codelineno-1-4">  4</a></span>
<span class="normal"><a href="#__codelineno-1-5">  5</a></span>
<span class="normal"><a href="#__codelineno-1-6">  6</a></span>
<span class="normal"><a href="#__codelineno-1-7">  7</a></span>
<span class="normal"><a href="#__codelineno-1-8">  8</a></span>
<span class="normal"><a href="#__codelineno-1-9">  9</a></span>
<span class="normal"><a href="#__codelineno-1-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-1-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-1-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-1-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-1-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-1-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-1-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-1-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-1-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-1-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-1-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-1-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-1-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-1-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-1-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-1-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-1-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-1-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-1-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-1-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-1-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-1-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-1-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-1-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-1-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-1-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-1-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-1-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-1-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-1-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-1-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-1-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-1-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-1-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-1-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-1-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-1-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-1-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-1-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-1-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-1-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-1-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-1-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-1-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-1-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-1-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-1-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-1-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-1-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-1-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-1-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-1-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-1-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-1-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-1-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-1-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-1-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-1-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-1-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-1-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-1-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-1-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-1-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-1-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-1-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-1-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-1-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-1-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-1-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-1-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-1-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-1-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-1-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-1-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-1-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-1-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-1-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-1-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-1-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-1-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-1-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-1-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-1-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-1-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-1-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-1-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-1-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-1-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-1-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-1-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-1-100">100</a></span>
<span class="normal"><a href="#__codelineno-1-101">101</a></span>
<span class="normal"><a href="#__codelineno-1-102">102</a></span>
<span class="normal"><a href="#__codelineno-1-103">103</a></span>
<span class="normal"><a href="#__codelineno-1-104">104</a></span>
<span class="normal"><a href="#__codelineno-1-105">105</a></span>
<span class="normal"><a href="#__codelineno-1-106">106</a></span>
<span class="normal"><a href="#__codelineno-1-107">107</a></span>
<span class="normal"><a href="#__codelineno-1-108">108</a></span>
<span class="normal"><a href="#__codelineno-1-109">109</a></span>
<span class="normal"><a href="#__codelineno-1-110">110</a></span>
<span class="normal"><a href="#__codelineno-1-111">111</a></span>
<span class="normal"><a href="#__codelineno-1-112">112</a></span>
<span class="normal"><a href="#__codelineno-1-113">113</a></span>
<span class="normal"><a href="#__codelineno-1-114">114</a></span>
<span class="normal"><a href="#__codelineno-1-115">115</a></span>
<span class="normal"><a href="#__codelineno-1-116">116</a></span>
<span class="normal"><a href="#__codelineno-1-117">117</a></span>
<span class="normal"><a href="#__codelineno-1-118">118</a></span>
<span class="normal"><a href="#__codelineno-1-119">119</a></span>
<span class="normal"><a href="#__codelineno-1-120">120</a></span>
<span class="normal"><a href="#__codelineno-1-121">121</a></span>
<span class="normal"><a href="#__codelineno-1-122">122</a></span>
<span class="normal"><a href="#__codelineno-1-123">123</a></span>
<span class="normal"><a href="#__codelineno-1-124">124</a></span>
<span class="normal"><a href="#__codelineno-1-125">125</a></span>
<span class="normal"><a href="#__codelineno-1-126">126</a></span>
<span class="normal"><a href="#__codelineno-1-127">127</a></span>
<span class="normal"><a href="#__codelineno-1-128">128</a></span>
<span class="normal"><a href="#__codelineno-1-129">129</a></span>
<span class="normal"><a href="#__codelineno-1-130">130</a></span>
<span class="normal"><a href="#__codelineno-1-131">131</a></span>
<span class="normal"><a href="#__codelineno-1-132">132</a></span>
<span class="normal"><a href="#__codelineno-1-133">133</a></span>
<span class="normal"><a href="#__codelineno-1-134">134</a></span>
<span class="normal"><a href="#__codelineno-1-135">135</a></span>
<span class="normal"><a href="#__codelineno-1-136">136</a></span>
<span class="normal"><a href="#__codelineno-1-137">137</a></span>
<span class="normal"><a href="#__codelineno-1-138">138</a></span>
<span class="normal"><a href="#__codelineno-1-139">139</a></span>
<span class="normal"><a href="#__codelineno-1-140">140</a></span>
<span class="normal"><a href="#__codelineno-1-141">141</a></span>
<span class="normal"><a href="#__codelineno-1-142">142</a></span>
<span class="normal"><a href="#__codelineno-1-143">143</a></span>
<span class="normal"><a href="#__codelineno-1-144">144</a></span>
<span class="normal"><a href="#__codelineno-1-145">145</a></span>
<span class="normal"><a href="#__codelineno-1-146">146</a></span>
<span class="normal"><a href="#__codelineno-1-147">147</a></span>
<span class="normal"><a href="#__codelineno-1-148">148</a></span>
<span class="normal"><a href="#__codelineno-1-149">149</a></span>
<span class="normal"><a href="#__codelineno-1-150">150</a></span>
<span class="normal"><a href="#__codelineno-1-151">151</a></span>
<span class="normal"><a href="#__codelineno-1-152">152</a></span>
<span class="normal"><a href="#__codelineno-1-153">153</a></span>
<span class="normal"><a href="#__codelineno-1-154">154</a></span>
<span class="normal"><a href="#__codelineno-1-155">155</a></span>
<span class="normal"><a href="#__codelineno-1-156">156</a></span>
<span class="normal"><a href="#__codelineno-1-157">157</a></span>
<span class="normal"><a href="#__codelineno-1-158">158</a></span>
<span class="normal"><a href="#__codelineno-1-159">159</a></span>
<span class="normal"><a href="#__codelineno-1-160">160</a></span>
<span class="normal"><a href="#__codelineno-1-161">161</a></span>
<span class="normal"><a href="#__codelineno-1-162">162</a></span>
<span class="normal"><a href="#__codelineno-1-163">163</a></span>
<span class="normal"><a href="#__codelineno-1-164">164</a></span>
<span class="normal"><a href="#__codelineno-1-165">165</a></span>
<span class="normal"><a href="#__codelineno-1-166">166</a></span>
<span class="normal"><a href="#__codelineno-1-167">167</a></span>
<span class="normal"><a href="#__codelineno-1-168">168</a></span>
<span class="normal"><a href="#__codelineno-1-169">169</a></span>
<span class="normal"><a href="#__codelineno-1-170">170</a></span>
<span class="normal"><a href="#__codelineno-1-171">171</a></span>
<span class="normal"><a href="#__codelineno-1-172">172</a></span>
<span class="normal"><a href="#__codelineno-1-173">173</a></span>
<span class="normal"><a href="#__codelineno-1-174">174</a></span>
<span class="normal"><a href="#__codelineno-1-175">175</a></span>
<span class="normal"><a href="#__codelineno-1-176">176</a></span>
<span class="normal"><a href="#__codelineno-1-177">177</a></span>
<span class="normal"><a href="#__codelineno-1-178">178</a></span>
<span class="normal"><a href="#__codelineno-1-179">179</a></span>
<span class="normal"><a href="#__codelineno-1-180">180</a></span>
<span class="normal"><a href="#__codelineno-1-181">181</a></span>
<span class="normal"><a href="#__codelineno-1-182">182</a></span>
<span class="normal"><a href="#__codelineno-1-183">183</a></span>
<span class="normal"><a href="#__codelineno-1-184">184</a></span>
<span class="normal"><a href="#__codelineno-1-185">185</a></span>
<span class="normal"><a href="#__codelineno-1-186">186</a></span>
<span class="normal"><a href="#__codelineno-1-187">187</a></span>
<span class="normal"><a href="#__codelineno-1-188">188</a></span>
<span class="normal"><a href="#__codelineno-1-189">189</a></span>
<span class="normal"><a href="#__codelineno-1-190">190</a></span>
<span class="normal"><a href="#__codelineno-1-191">191</a></span>
<span class="normal"><a href="#__codelineno-1-192">192</a></span>
<span class="normal"><a href="#__codelineno-1-193">193</a></span>
<span class="normal"><a href="#__codelineno-1-194">194</a></span>
<span class="normal"><a href="#__codelineno-1-195">195</a></span>
<span class="normal"><a href="#__codelineno-1-196">196</a></span>
<span class="normal"><a href="#__codelineno-1-197">197</a></span>
<span class="normal"><a href="#__codelineno-1-198">198</a></span>
<span class="normal"><a href="#__codelineno-1-199">199</a></span>
<span class="normal"><a href="#__codelineno-1-200">200</a></span>
<span class="normal"><a href="#__codelineno-1-201">201</a></span>
<span class="normal"><a href="#__codelineno-1-202">202</a></span>
<span class="normal"><a href="#__codelineno-1-203">203</a></span>
<span class="normal"><a href="#__codelineno-1-204">204</a></span>
<span class="normal"><a href="#__codelineno-1-205">205</a></span>
<span class="normal"><a href="#__codelineno-1-206">206</a></span>
<span class="normal"><a href="#__codelineno-1-207">207</a></span>
<span class="normal"><a href="#__codelineno-1-208">208</a></span>
<span class="normal"><a href="#__codelineno-1-209">209</a></span>
<span class="normal"><a href="#__codelineno-1-210">210</a></span>
<span class="normal"><a href="#__codelineno-1-211">211</a></span>
<span class="normal"><a href="#__codelineno-1-212">212</a></span>
<span class="normal"><a href="#__codelineno-1-213">213</a></span>
<span class="normal"><a href="#__codelineno-1-214">214</a></span>
<span class="normal"><a href="#__codelineno-1-215">215</a></span>
<span class="normal"><a href="#__codelineno-1-216">216</a></span>
<span class="normal"><a href="#__codelineno-1-217">217</a></span>
<span class="normal"><a href="#__codelineno-1-218">218</a></span>
<span class="normal"><a href="#__codelineno-1-219">219</a></span>
<span class="normal"><a href="#__codelineno-1-220">220</a></span>
<span class="normal"><a href="#__codelineno-1-221">221</a></span>
<span class="normal"><a href="#__codelineno-1-222">222</a></span>
<span class="normal"><a href="#__codelineno-1-223">223</a></span>
<span class="normal"><a href="#__codelineno-1-224">224</a></span>
<span class="normal"><a href="#__codelineno-1-225">225</a></span>
<span class="normal"><a href="#__codelineno-1-226">226</a></span>
<span class="normal"><a href="#__codelineno-1-227">227</a></span>
<span class="normal"><a href="#__codelineno-1-228">228</a></span>
<span class="normal"><a href="#__codelineno-1-229">229</a></span>
<span class="normal"><a href="#__codelineno-1-230">230</a></span>
<span class="normal"><a href="#__codelineno-1-231">231</a></span>
<span class="normal"><a href="#__codelineno-1-232">232</a></span>
<span class="normal"><a href="#__codelineno-1-233">233</a></span>
<span class="normal"><a href="#__codelineno-1-234">234</a></span>
<span class="normal"><a href="#__codelineno-1-235">235</a></span>
<span class="normal"><a href="#__codelineno-1-236">236</a></span>
<span class="normal"><a href="#__codelineno-1-237">237</a></span>
<span class="normal"><a href="#__codelineno-1-238">238</a></span>
<span class="normal"><a href="#__codelineno-1-239">239</a></span>
<span class="normal"><a href="#__codelineno-1-240">240</a></span>
<span class="normal"><a href="#__codelineno-1-241">241</a></span>
<span class="normal"><a href="#__codelineno-1-242">242</a></span>
<span class="normal"><a href="#__codelineno-1-243">243</a></span>
<span class="normal"><a href="#__codelineno-1-244">244</a></span>
<span class="normal"><a href="#__codelineno-1-245">245</a></span>
<span class="normal"><a href="#__codelineno-1-246">246</a></span>
<span class="normal"><a href="#__codelineno-1-247">247</a></span>
<span class="normal"><a href="#__codelineno-1-248">248</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="cm">/**</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="cm"> * \file acceleration_barnes_hut.c</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="cm"> * \brief Implementation of Barnes-Hut algorithm</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="cm"> * </span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="cm"> * \author Ching-Yin Ng</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="cm"> */</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="cp">#ifdef USE_OPENMP</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="cp">#endif</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;acceleration.h&quot;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;linear_octree.h&quot;</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="cm">/**</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="cm"> * \brief Helper function to compute acceleration</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="cm"> * </span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="cm"> * \param[out] a Array of acceleration vectors to be modified</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="cm"> * \param[in] system Pointer to the gravitational system</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="cm"> * \param[in] acceleration_param Pointer to the acceleration parameters</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="cm"> * \param[in] octree Pointer to the linear octree</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="cm"> */</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="n">IN_FILE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">helper_compute_acceleration</span><span class="p">(</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">system</span><span class="p">,</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">AccelerationParam</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">acceleration_param</span><span class="p">,</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">LinearOctree</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">octree</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="p">);</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="n">WIN32DLL_API</span><span class="w"> </span><span class="n">ErrorStatus</span><span class="w"> </span><span class="n">acceleration_barnes_hut</span><span class="p">(</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">system</span><span class="p">,</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">AccelerationParam</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">acceleration_param</span>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="p">)</span>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="p">{</span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">    </span><span class="n">ErrorStatus</span><span class="w"> </span><span class="n">error_status</span><span class="p">;</span>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">    </span><span class="cm">/* Empty the input array */</span>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">system</span><span class="o">-&gt;</span><span class="n">num_particles</span><span class="p">;</span>
<a id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_particles</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-1-48" name="__codelineno-1-48"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-49" name="__codelineno-1-49"></a>
<a id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">    </span><span class="cm">/* Construct octree */</span>
<a id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="w">    </span><span class="n">LinearOctree</span><span class="w"> </span><span class="n">octree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_new_linear_octree</span><span class="p">();</span>
<a id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">    </span><span class="n">error_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRAP_TRACEBACK</span><span class="p">(</span><span class="n">construct_octree</span><span class="p">(</span>
<a id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">octree</span><span class="p">,</span>
<a id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="w">        </span><span class="n">system</span><span class="p">,</span>
<a id="__codelineno-1-55" name="__codelineno-1-55"></a><span class="w">        </span><span class="n">acceleration_param</span><span class="p">,</span>
<a id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="w">        </span><span class="nb">NULL</span><span class="p">,</span>
<a id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="w">        </span><span class="mf">-1.0</span>
<a id="__codelineno-1-58" name="__codelineno-1-58"></a><span class="w">    </span><span class="p">));</span>
<a id="__codelineno-1-59" name="__codelineno-1-59"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error_status</span><span class="p">.</span><span class="n">return_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GRAV_SUCCESS</span><span class="p">)</span>
<a id="__codelineno-1-60" name="__codelineno-1-60"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-1-61" name="__codelineno-1-61"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_status</span><span class="p">;</span>
<a id="__codelineno-1-62" name="__codelineno-1-62"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-63" name="__codelineno-1-63"></a>
<a id="__codelineno-1-64" name="__codelineno-1-64"></a><span class="w">    </span><span class="cm">/* Compute acceleration */</span>
<a id="__codelineno-1-65" name="__codelineno-1-65"></a><span class="w">    </span><span class="n">helper_compute_acceleration</span><span class="p">(</span>
<a id="__codelineno-1-66" name="__codelineno-1-66"></a><span class="w">        </span><span class="n">a</span><span class="p">,</span>
<a id="__codelineno-1-67" name="__codelineno-1-67"></a><span class="w">        </span><span class="n">system</span><span class="p">,</span>
<a id="__codelineno-1-68" name="__codelineno-1-68"></a><span class="w">        </span><span class="n">acceleration_param</span><span class="p">,</span>
<a id="__codelineno-1-69" name="__codelineno-1-69"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">octree</span>
<a id="__codelineno-1-70" name="__codelineno-1-70"></a><span class="w">    </span><span class="p">);</span>
<a id="__codelineno-1-71" name="__codelineno-1-71"></a>
<a id="__codelineno-1-72" name="__codelineno-1-72"></a><span class="w">    </span><span class="cm">/* Free memory */</span>
<a id="__codelineno-1-73" name="__codelineno-1-73"></a><span class="w">    </span><span class="n">free_linear_octree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">octree</span><span class="p">);</span>
<a id="__codelineno-1-74" name="__codelineno-1-74"></a>
<a id="__codelineno-1-75" name="__codelineno-1-75"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">make_success_error_status</span><span class="p">();</span>
<a id="__codelineno-1-76" name="__codelineno-1-76"></a><span class="p">}</span>
<a id="__codelineno-1-77" name="__codelineno-1-77"></a>
<a id="__codelineno-1-78" name="__codelineno-1-78"></a><span class="n">IN_FILE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">helper_compute_acceleration</span><span class="p">(</span>
<a id="__codelineno-1-79" name="__codelineno-1-79"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
<a id="__codelineno-1-80" name="__codelineno-1-80"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">system</span><span class="p">,</span>
<a id="__codelineno-1-81" name="__codelineno-1-81"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">AccelerationParam</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">acceleration_param</span><span class="p">,</span>
<a id="__codelineno-1-82" name="__codelineno-1-82"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">LinearOctree</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">octree</span>
<a id="__codelineno-1-83" name="__codelineno-1-83"></a><span class="p">)</span>
<a id="__codelineno-1-84" name="__codelineno-1-84"></a><span class="p">{</span>
<a id="__codelineno-1-85" name="__codelineno-1-85"></a><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Stack</span>
<a id="__codelineno-1-86" name="__codelineno-1-86"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-1-87" name="__codelineno-1-87"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">node</span><span class="p">;</span>
<a id="__codelineno-1-88" name="__codelineno-1-88"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">processed_children</span><span class="p">;</span>
<a id="__codelineno-1-89" name="__codelineno-1-89"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">Stack</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span>
<a id="__codelineno-1-90" name="__codelineno-1-90"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">Stack</span><span class="p">;</span>
<a id="__codelineno-1-91" name="__codelineno-1-91"></a>
<a id="__codelineno-1-92" name="__codelineno-1-92"></a><span class="w">    </span><span class="cm">/* Declare variables */</span>
<a id="__codelineno-1-93" name="__codelineno-1-93"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">system</span><span class="o">-&gt;</span><span class="n">num_particles</span><span class="p">;</span>
<a id="__codelineno-1-94" name="__codelineno-1-94"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">system</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
<a id="__codelineno-1-95" name="__codelineno-1-95"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">system</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>
<a id="__codelineno-1-96" name="__codelineno-1-96"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">system</span><span class="o">-&gt;</span><span class="n">G</span><span class="p">;</span>
<a id="__codelineno-1-97" name="__codelineno-1-97"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">softening_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acceleration_param</span><span class="o">-&gt;</span><span class="n">softening_length</span><span class="p">;</span>
<a id="__codelineno-1-98" name="__codelineno-1-98"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">softening_length_squared</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">softening_length</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">softening_length</span><span class="p">;</span>
<a id="__codelineno-1-99" name="__codelineno-1-99"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">opening_angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acceleration_param</span><span class="o">-&gt;</span><span class="n">opening_angle</span><span class="p">;</span>
<a id="__codelineno-1-100" name="__codelineno-1-100"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">opening_angle_squared</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opening_angle</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">opening_angle</span><span class="p">;</span>
<a id="__codelineno-1-101" name="__codelineno-1-101"></a>
<a id="__codelineno-1-102" name="__codelineno-1-102"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">box_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">box_width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span>
<a id="__codelineno-1-103" name="__codelineno-1-103"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">int64</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">particle_morton_indices_deepest_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">particle_morton_indices_deepest_level</span><span class="p">;</span>
<a id="__codelineno-1-104" name="__codelineno-1-104"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">sorted_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">sorted_indices</span><span class="p">;</span>
<a id="__codelineno-1-105" name="__codelineno-1-105"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_num_particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_particles</span><span class="p">;</span>
<a id="__codelineno-1-106" name="__codelineno-1-106"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_num_internal_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_num_internal_children</span><span class="p">;</span>
<a id="__codelineno-1-107" name="__codelineno-1-107"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_first_particle_sorted_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_particle_sorted_idx</span><span class="p">;</span>
<a id="__codelineno-1-108" name="__codelineno-1-108"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_first_internal_children_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_first_internal_children_idx</span><span class="p">;</span>
<a id="__codelineno-1-109" name="__codelineno-1-109"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_mass</span><span class="p">;</span>
<a id="__codelineno-1-110" name="__codelineno-1-110"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_center_of_mass_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_x</span><span class="p">;</span>
<a id="__codelineno-1-111" name="__codelineno-1-111"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_center_of_mass_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_y</span><span class="p">;</span>
<a id="__codelineno-1-112" name="__codelineno-1-112"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">tree_center_of_mass_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">octree</span><span class="o">-&gt;</span><span class="n">tree_center_of_mass_z</span><span class="p">;</span>
<a id="__codelineno-1-113" name="__codelineno-1-113"></a>
<a id="__codelineno-1-114" name="__codelineno-1-114"></a><span class="cp">#ifdef USE_OPENMP</span>
<a id="__codelineno-1-115" name="__codelineno-1-115"></a><span class="w">    </span><span class="cp">#pragma omp parallel for</span>
<a id="__codelineno-1-116" name="__codelineno-1-116"></a><span class="cp">#endif</span>
<a id="__codelineno-1-117" name="__codelineno-1-117"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_particles</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-1-118" name="__codelineno-1-118"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-1-119" name="__codelineno-1-119"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idx_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sorted_indices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w">    </span><span class="c1">// For coalesced memory access</span>
<a id="__codelineno-1-120" name="__codelineno-1-120"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">int64</span><span class="w"> </span><span class="n">morton_index_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particle_morton_indices_deepest_level</span><span class="p">[</span><span class="n">idx_i</span><span class="p">];</span>
<a id="__codelineno-1-121" name="__codelineno-1-121"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">x_i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="n">idx_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">idx_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">idx_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]};</span>
<a id="__codelineno-1-122" name="__codelineno-1-122"></a>
<a id="__codelineno-1-123" name="__codelineno-1-123"></a><span class="w">        </span><span class="n">Stack</span><span class="w"> </span><span class="n">stack</span><span class="p">[</span><span class="n">MORTON_MAX_LEVEL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-1-124" name="__codelineno-1-124"></a><span class="w">        </span><span class="n">Stack</span><span class="w"> </span><span class="o">*</span><span class="n">current_stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-1-125" name="__codelineno-1-125"></a><span class="w">        </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-1-126" name="__codelineno-1-126"></a><span class="w">        </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-1-127" name="__codelineno-1-127"></a><span class="w">        </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-1-128" name="__codelineno-1-128"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">acceleration</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>
<a id="__codelineno-1-129" name="__codelineno-1-129"></a>
<a id="__codelineno-1-130" name="__codelineno-1-130"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-1-131" name="__codelineno-1-131"></a>
<a id="__codelineno-1-132" name="__codelineno-1-132"></a><span class="w">        </span><span class="cm">/* Tree walk */</span>
<a id="__codelineno-1-133" name="__codelineno-1-133"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span>
<a id="__codelineno-1-134" name="__codelineno-1-134"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-1-135" name="__codelineno-1-135"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">current_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
<a id="__codelineno-1-136" name="__codelineno-1-136"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tree_num_internal_children</span><span class="p">[</span><span class="n">current_node</span><span class="p">];</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-1-137" name="__codelineno-1-137"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-1-138" name="__codelineno-1-138"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">child_j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree_first_internal_children_idx</span><span class="p">[</span><span class="n">current_node</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<a id="__codelineno-1-139" name="__codelineno-1-139"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_children_j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree_num_internal_children</span><span class="p">[</span><span class="n">child_j</span><span class="p">];</span>
<a id="__codelineno-1-140" name="__codelineno-1-140"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">start_idx_j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree_first_particle_sorted_idx</span><span class="p">[</span><span class="n">child_j</span><span class="p">];</span>
<a id="__codelineno-1-141" name="__codelineno-1-141"></a>
<a id="__codelineno-1-142" name="__codelineno-1-142"></a><span class="w">                </span><span class="c1">// If object i is included, then we need to traverse deeper</span>
<a id="__codelineno-1-143" name="__codelineno-1-143"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_included</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linear_octree_check_if_included</span><span class="p">(</span>
<a id="__codelineno-1-144" name="__codelineno-1-144"></a><span class="w">                    </span><span class="n">morton_index_i</span><span class="p">,</span>
<a id="__codelineno-1-145" name="__codelineno-1-145"></a><span class="w">                    </span><span class="n">particle_morton_indices_deepest_level</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">[</span><span class="n">start_idx_j</span><span class="p">]],</span>
<a id="__codelineno-1-146" name="__codelineno-1-146"></a><span class="w">                    </span><span class="n">level</span>
<a id="__codelineno-1-147" name="__codelineno-1-147"></a><span class="w">                </span><span class="p">);</span>
<a id="__codelineno-1-148" name="__codelineno-1-148"></a>
<a id="__codelineno-1-149" name="__codelineno-1-149"></a><span class="w">                </span><span class="c1">// Check Barnes-Hut criteria</span>
<a id="__codelineno-1-150" name="__codelineno-1-150"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_included</span><span class="p">)</span>
<a id="__codelineno-1-151" name="__codelineno-1-151"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-1-152" name="__codelineno-1-152"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-153" name="__codelineno-1-153"></a><span class="w">                        </span><span class="n">x_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tree_center_of_mass_x</span><span class="p">[</span><span class="n">child_j</span><span class="p">],</span>
<a id="__codelineno-1-154" name="__codelineno-1-154"></a><span class="w">                        </span><span class="n">x_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tree_center_of_mass_y</span><span class="p">[</span><span class="n">child_j</span><span class="p">],</span>
<a id="__codelineno-1-155" name="__codelineno-1-155"></a><span class="w">                        </span><span class="n">x_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tree_center_of_mass_z</span><span class="p">[</span><span class="n">child_j</span><span class="p">]</span>
<a id="__codelineno-1-156" name="__codelineno-1-156"></a><span class="w">                    </span><span class="p">};</span>
<a id="__codelineno-1-157" name="__codelineno-1-157"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">box_length_j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">box_length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">level</span><span class="p">);</span>
<a id="__codelineno-1-158" name="__codelineno-1-158"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">norm_square</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-1-159" name="__codelineno-1-159"></a>
<a id="__codelineno-1-160" name="__codelineno-1-160"></a><span class="w">                    </span><span class="c1">// Check if box_length_j / norm &lt; opening_angle</span>
<a id="__codelineno-1-161" name="__codelineno-1-161"></a><span class="w">                    </span><span class="c1">// Use squared values to avoid sqrt</span>
<a id="__codelineno-1-162" name="__codelineno-1-162"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">box_length_j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">box_length_j</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">opening_angle_squared</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">norm_square</span><span class="p">)</span>
<a id="__codelineno-1-163" name="__codelineno-1-163"></a><span class="w">                    </span><span class="p">{</span>
<a id="__codelineno-1-164" name="__codelineno-1-164"></a><span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">R_norm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span>
<a id="__codelineno-1-165" name="__codelineno-1-165"></a><span class="w">                            </span><span class="n">norm_square</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">softening_length_squared</span>
<a id="__codelineno-1-166" name="__codelineno-1-166"></a><span class="w">                        </span><span class="p">);</span>
<a id="__codelineno-1-167" name="__codelineno-1-167"></a>
<a id="__codelineno-1-168" name="__codelineno-1-168"></a><span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">temp_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tree_mass</span><span class="p">[</span><span class="n">child_j</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">R_norm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R_norm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R_norm</span><span class="p">);</span>
<a id="__codelineno-1-169" name="__codelineno-1-169"></a><span class="w">                        </span><span class="n">acceleration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">temp_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-1-170" name="__codelineno-1-170"></a><span class="w">                        </span><span class="n">acceleration</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">temp_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-1-171" name="__codelineno-1-171"></a><span class="w">                        </span><span class="n">acceleration</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">temp_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-1-172" name="__codelineno-1-172"></a>
<a id="__codelineno-1-173" name="__codelineno-1-173"></a><span class="w">                        </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<a id="__codelineno-1-174" name="__codelineno-1-174"></a><span class="w">                        </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-1-175" name="__codelineno-1-175"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-1-176" name="__codelineno-1-176"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-1-177" name="__codelineno-1-177"></a>
<a id="__codelineno-1-178" name="__codelineno-1-178"></a><span class="w">                </span><span class="cm">/* Traverse deeper */</span>
<a id="__codelineno-1-179" name="__codelineno-1-179"></a>
<a id="__codelineno-1-180" name="__codelineno-1-180"></a><span class="w">                </span><span class="cm">/* Leaf node */</span>
<a id="__codelineno-1-181" name="__codelineno-1-181"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_children_j</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-1-182" name="__codelineno-1-182"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-1-183" name="__codelineno-1-183"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_particles_j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree_num_particles</span><span class="p">[</span><span class="n">child_j</span><span class="p">];</span>
<a id="__codelineno-1-184" name="__codelineno-1-184"></a><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_particles_j</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-1-185" name="__codelineno-1-185"></a><span class="w">                    </span><span class="p">{</span>
<a id="__codelineno-1-186" name="__codelineno-1-186"></a><span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idx_j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sorted_indices</span><span class="p">[</span><span class="n">start_idx_j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">];</span>
<a id="__codelineno-1-187" name="__codelineno-1-187"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx_i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">idx_j</span><span class="p">)</span>
<a id="__codelineno-1-188" name="__codelineno-1-188"></a><span class="w">                        </span><span class="p">{</span>
<a id="__codelineno-1-189" name="__codelineno-1-189"></a><span class="w">                            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-1-190" name="__codelineno-1-190"></a><span class="w">                        </span><span class="p">}</span>
<a id="__codelineno-1-191" name="__codelineno-1-191"></a>
<a id="__codelineno-1-192" name="__codelineno-1-192"></a><span class="w">                        </span><span class="c1">// Calculate \vec{R} and its norm</span>
<a id="__codelineno-1-193" name="__codelineno-1-193"></a><span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-194" name="__codelineno-1-194"></a><span class="w">                            </span><span class="n">x_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">idx_j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-1-195" name="__codelineno-1-195"></a><span class="w">                            </span><span class="n">x_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">idx_j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-1-196" name="__codelineno-1-196"></a><span class="w">                            </span><span class="n">x_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">idx_j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-1-197" name="__codelineno-1-197"></a><span class="w">                        </span><span class="p">};</span>
<a id="__codelineno-1-198" name="__codelineno-1-198"></a><span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">R_norm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span>
<a id="__codelineno-1-199" name="__codelineno-1-199"></a><span class="w">                            </span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<a id="__codelineno-1-200" name="__codelineno-1-200"></a><span class="w">                            </span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<a id="__codelineno-1-201" name="__codelineno-1-201"></a><span class="w">                            </span><span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<a id="__codelineno-1-202" name="__codelineno-1-202"></a><span class="w">                            </span><span class="n">softening_length_squared</span>
<a id="__codelineno-1-203" name="__codelineno-1-203"></a><span class="w">                        </span><span class="p">);</span>
<a id="__codelineno-1-204" name="__codelineno-1-204"></a>
<a id="__codelineno-1-205" name="__codelineno-1-205"></a><span class="w">                        </span><span class="c1">// Calculate the acceleration</span>
<a id="__codelineno-1-206" name="__codelineno-1-206"></a><span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">temp_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="n">idx_j</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">R_norm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R_norm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R_norm</span><span class="p">);</span>
<a id="__codelineno-1-207" name="__codelineno-1-207"></a><span class="w">                        </span><span class="n">acceleration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">temp_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-1-208" name="__codelineno-1-208"></a><span class="w">                        </span><span class="n">acceleration</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">temp_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-1-209" name="__codelineno-1-209"></a><span class="w">                        </span><span class="n">acceleration</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">temp_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-1-210" name="__codelineno-1-210"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-1-211" name="__codelineno-1-211"></a>
<a id="__codelineno-1-212" name="__codelineno-1-212"></a><span class="w">                    </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<a id="__codelineno-1-213" name="__codelineno-1-213"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-1-214" name="__codelineno-1-214"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-1-215" name="__codelineno-1-215"></a>
<a id="__codelineno-1-216" name="__codelineno-1-216"></a><span class="w">                </span><span class="cm">/* Internal node */</span>
<a id="__codelineno-1-217" name="__codelineno-1-217"></a><span class="w">                </span><span class="k">else</span>
<a id="__codelineno-1-218" name="__codelineno-1-218"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-1-219" name="__codelineno-1-219"></a><span class="w">                    </span><span class="n">Stack</span><span class="w"> </span><span class="o">*</span><span class="n">new_item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">level</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-1-220" name="__codelineno-1-220"></a><span class="w">                    </span><span class="n">new_item</span><span class="o">-&gt;</span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">child_j</span><span class="p">;</span>
<a id="__codelineno-1-221" name="__codelineno-1-221"></a><span class="w">                    </span><span class="n">new_item</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-1-222" name="__codelineno-1-222"></a><span class="w">                    </span><span class="n">new_item</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_stack</span><span class="p">;</span>
<a id="__codelineno-1-223" name="__codelineno-1-223"></a>
<a id="__codelineno-1-224" name="__codelineno-1-224"></a><span class="w">                    </span><span class="n">current_stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_item</span><span class="p">;</span>
<a id="__codelineno-1-225" name="__codelineno-1-225"></a><span class="w">                    </span><span class="n">level</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-1-226" name="__codelineno-1-226"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-1-227" name="__codelineno-1-227"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-1-228" name="__codelineno-1-228"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-1-229" name="__codelineno-1-229"></a>
<a id="__codelineno-1-230" name="__codelineno-1-230"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">tree_num_internal_children</span><span class="p">[</span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">])</span>
<a id="__codelineno-1-231" name="__codelineno-1-231"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-1-232" name="__codelineno-1-232"></a><span class="w">                </span><span class="n">Stack</span><span class="w"> </span><span class="o">*</span><span class="n">parent_stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
<a id="__codelineno-1-233" name="__codelineno-1-233"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">parent_stack</span><span class="p">)</span>
<a id="__codelineno-1-234" name="__codelineno-1-234"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-1-235" name="__codelineno-1-235"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-1-236" name="__codelineno-1-236"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-1-237" name="__codelineno-1-237"></a>
<a id="__codelineno-1-238" name="__codelineno-1-238"></a><span class="w">                </span><span class="n">current_stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent_stack</span><span class="p">;</span>
<a id="__codelineno-1-239" name="__codelineno-1-239"></a><span class="w">                </span><span class="n">current_stack</span><span class="o">-&gt;</span><span class="n">processed_children</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-1-240" name="__codelineno-1-240"></a><span class="w">                </span><span class="n">level</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-1-241" name="__codelineno-1-241"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-1-242" name="__codelineno-1-242"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-1-243" name="__codelineno-1-243"></a>
<a id="__codelineno-1-244" name="__codelineno-1-244"></a><span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="n">idx_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acceleration</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-1-245" name="__codelineno-1-245"></a><span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="n">idx_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acceleration</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-1-246" name="__codelineno-1-246"></a><span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="n">idx_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acceleration</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-1-247" name="__codelineno-1-247"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-248" name="__codelineno-1-248"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</details>
<p>To compute the acceleration, we use a stack to traverse the tree recursively:</p>
<ol>
<li>Push the root node to the stack.</li>
<li>While the stack is not empty:<ul>
<li>2.1 Pop the top node from the stack.</li>
<li>2.2 If the node is a leaf node, compute the acceleration directly.</li>
<li>2.3 If the node is not a leaf node, check if it passes the opening angle criterion.
    If yes, compute the acceleration using the center of mass of the node.
    Otherwise, push all child nodes to the stack.</li>
</ul>
</li>
</ol>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>We need to check whether the current node is included in the branch to avoid
self-interaction. This can be done by a simple check of the Morton index.</p>
</div>
<h2 id="benchmark">Benchmark</h2>
<p>Here we provide a simple benchmark of the Barnes-Hut algorithm compared to the brute-force 
algorithm. It was done on Macbook Air M1. The brute-force algorithm spent 18.6 seconds 
on <span class="arithmatex">\(N = 10^5\)</span>, while the Barnes-Hut algorithm
with <span class="arithmatex">\(\theta = 1\)</span> and <span class="arithmatex">\(\theta = 0.5\)</span> spent <span class="arithmatex">\(7.94\)</span> s on <span class="arithmatex">\(N = 10^6\)</span> and
<span class="arithmatex">\(18.2\)</span> s on <span class="arithmatex">\(N = 10^7\)</span> respectively. This shows that Barnes-Hut algorithm could handle 10-100 times more particles
than the brute force algorithm.</p>
<p>(For the benchmark, the particles are uniformly distributed where <span class="arithmatex">\(\{x, y, z\} \sim U(-1, 1)\)</span>)</p>
<figure style="text-align: center;">
  <img src="../../../examples/media/barnes_hut_benchmark.png" alt="Baranes-Hut benchmark" width="600" style="display: block; margin: auto;" />
</figure>
<div class="footnote">
<hr />
<ol>
<li id="fn:barnes_hierarchical_1986">
<p>Josh Barnes and Piet Hut. A hierarchical <span class="arithmatex">\(O\)</span>(<span class="arithmatex">\(N\)</span> $\log $ <span class="arithmatex">\(N\)</span>) force-calculation algorithm. <em>Nature</em>, 324(6096):446–449, December 1986. URL: <a href="https://www.nature.com/articles/324446a0">https://www.nature.com/articles/324446a0</a> (visited on 2025-01-19), <a href="https://doi.org/10.1038/324446a0">doi:10.1038/324446a0</a>.&#160;<a class="footnote-backref" href="#fnref:barnes_hierarchical_1986" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:morton_index_stackoverflow">
<p>Gabriel (<a href="https://stackoverflow.com/users/293195/gabriel">https://stackoverflow.com/users/293195/gabriel</a>). How to compute a 3d morton number (interleave the bits of 3 ints). Stack Overflow. version: 2021-09-18. URL: <a href="https://stackoverflow.com/a/18528775">https://stackoverflow.com/a/18528775</a>, <a href="https://arxiv.org/abs/https://stackoverflow.com/a/18528775">arXiv:https://stackoverflow.com/a/18528775</a>.&#160;<a class="footnote-backref" href="#fnref:morton_index_stackoverflow" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>







  
  






  <h2 id="__comments">Comments</h2>
  <script src="https://giscus.app/client.js"
    data-repo="alvinng4/grav_sim"
    data-repo-id="R_kgDOLAVUeQ"
    data-category="General"
    data-category-id="DIC_kwDOLAVUec4CpJ_a"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="preferred_color_scheme"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme) 
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 <a href='https://github.com/alvinng4'  target='_blank' rel='noopener'>Ching-Yin Ng</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.sections", "navigation.top", "navigation.indexes", "toc.integrate", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy", "content.tooltips"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>